#Requires -RunAsAdministrator

<#
.SYNOPSIS
    Automated C: Drive Organization with Progress Bar
    
.DESCRIPTION
    This script automatically moves important folders from C: to H: drive or NAS
    with real-time progress bars and status updates.
    
.PARAMETER DestinationType
    "Drive" or "NAS" - Where to move files
    
.PARAMETER DestinationDrive
    Drive letter for local destination (e.g., "H:")
    
.PARAMETER NASPath
    UNC path to NAS (e.g., "\\192.168.1.100\Backup")
    
.PARAMETER AutoConfirm
    Skip confirmation prompts
    
.EXAMPLE
    .\Automated-C-Drive-Organization-GUI.ps1 -DestinationType "Drive" -DestinationDrive "H:"
#>

param(
    [Parameter(Mandatory=$true)]
    [ValidateSet("Drive", "NAS")]
    [string]$DestinationType,
    
    [Parameter(Mandatory=$false)]
    [string]$DestinationDrive = "H:",
    
    [Parameter(Mandatory=$false)]
    [string]$NASPath = "",
    
    [Parameter(Mandatory=$false)]
    [switch]$AutoConfirm,
    
    [Parameter(Mandatory=$false)]
    [switch]$SkipBrowser,
    
    [Parameter(Mandatory=$false)]
    [switch]$SkipDocker,
    
    [Parameter(Mandatory=$false)]
    [switch]$DryRun
)

# ============================================================================
# PROGRESS BAR FUNCTIONS
# ============================================================================

function Show-ProgressBar {
    param(
        [int]$Current,
        [int]$Total,
        [string]$Activity,
        [string]$Status = "Processing",
        [int]$Id = 0
    )
    
    $percent = [math]::Round(($Current / $Total) * 100, 0)
    
    Write-Progress -Id $Id `
                   -Activity $Activity `
                   -Status "$Status ($Current of $Total) - $percent%" `
                   -PercentComplete $percent
}

function Show-SubProgress {
    param(
        [int]$Current,
        [int]$Total,
        [string]$Activity,
        [string]$Status = "Processing"
    )
    
    $percent = [math]::Round(($Current / $Total) * 100, 0)
    
    Write-Progress -Id 1 `
                   -ParentId 0 `
                   -Activity $Activity `
                   -Status "$Status - $percent%" `
                   -PercentComplete $percent
}

function Write-StatusLine {
    param(
        [string]$Icon,
        [string]$Text,
        [string]$Color = "White",
        [switch]$NoNewLine
    )
    
    if ($NoNewLine) {
        Write-Host "$Icon $Text" -ForegroundColor $Color -NoNewline
    } else {
        Write-Host "$Icon $Text" -ForegroundColor $Color
    }
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

$script:colors = @{
    Header = "Cyan"
    Success = "Green"
    Warning = "Yellow"
    Error = "Red"
    Info = "White"
    Progress = "Magenta"
}

$script:stats = @{
    TotalFiles = 0
    TotalSize = 0
    MoveSuccess = 0
    MoveFailed = 0
    Folders = @()
}

function Write-Header {
    param([string]$Text)
    Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor $colors.Header
    Write-Host "â•‘  $($Text.PadRight(60)) â•‘" -ForegroundColor $colors.Header
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $colors.Header
}

function Write-Step {
    param([string]$Text, [string]$Color = "Cyan")
    Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor DarkGray
    Write-Host "â–¶ $Text" -ForegroundColor $Color
    Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor DarkGray
    Write-Host ""
}

function Get-FolderSize {
    param([string]$Path)
    try {
        $size = (Get-ChildItem $Path -Recurse -File -ErrorAction SilentlyContinue | 
                 Measure-Object -Property Length -Sum).Sum
        return [math]::Round($size/1GB, 2)
    } catch {
        return 0
    }
}

function Get-FileCount {
    param([string]$Path)
    try {
        return (Get-ChildItem $Path -Recurse -File -ErrorAction SilentlyContinue | Measure-Object).Count
    } catch {
        return 0
    }
}

function Test-PathExists {
    param([string]$Path)
    return (Test-Path $Path -ErrorAction SilentlyContinue)
}

function Move-FolderWithProgress {
    param(
        [string]$Source,
        [string]$Destination,
        [string]$FolderName,
        [bool]$CreateSymlink = $true,
        [int]$FolderIndex = 1,
        [int]$TotalFolders = 1
    )
    
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
    Write-Host "â•‘  Processing Folder $FolderIndex of $TotalFolders" -ForegroundColor Cyan -NoNewline
    Write-Host (" " * (60 - "  Processing Folder $FolderIndex of $TotalFolders".Length)) -NoNewline
    Write-Host "â•‘" -ForegroundColor Cyan
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
    Write-Host ""
    
    Write-StatusLine "ğŸ“¦" "Folder: $FolderName" "Cyan"
    Write-StatusLine "ğŸ“‚" "Source: $Source" "Gray"
    Write-StatusLine "ğŸ“" "Destination: $Destination" "Gray"
    Write-Host ""
    
    if (!(Test-PathExists $Source)) {
        Write-StatusLine "âš ï¸" "Source not found - skipping" $colors.Warning
        return $false
    }
    
    # Calculate size with progress
    Write-StatusLine "â³" "Calculating size..." $colors.Progress -NoNewLine
    
    Show-ProgressBar -Current $FolderIndex -Total $TotalFolders `
                     -Activity "Overall Progress: $FolderName" `
                     -Status "Calculating size" -Id 0
    
    $sizeGB = Get-FolderSize $Source
    $fileCount = Get-FileCount $Source
    
    Write-Host " Done!" -ForegroundColor $colors.Success
    
    Write-StatusLine "ğŸ’¾" "Size: $sizeGB GB" $colors.Info
    Write-StatusLine "ğŸ“„" "Files: $fileCount" $colors.Info
    Write-Host ""
    
    if ($sizeGB -eq 0) {
        Write-StatusLine "âš ï¸" "Folder is empty - skipping" $colors.Warning
        Write-Progress -Id 0 -Activity "Overall Progress" -Completed
        Write-Progress -Id 1 -Activity "Sub Progress" -Completed
        return $false
    }
    
    $script:stats.TotalFiles += $fileCount
    $script:stats.TotalSize += $sizeGB
    
    if ($DryRun) {
        Write-StatusLine "ğŸ”" "[DRY RUN] Would copy to $Destination" $colors.Progress
        Write-Progress -Id 0 -Activity "Overall Progress" -Completed
        Write-Progress -Id 1 -Activity "Sub Progress" -Completed
        return $true
    }
    
    try {
        # Show copy progress
        Write-StatusLine "ğŸ“‚" "Copying files..." $colors.Progress
        Write-Host ""
        
        # Create destination directory
        if (!(Test-Path $Destination)) {
            New-Item -ItemType Directory -Path $Destination -Force | Out-Null
        }
        
        # Use robocopy with progress tracking
        $robocopyLog = "$env:TEMP\robocopy_$([guid]::NewGuid()).log"
        
        $robocopyArgs = @(
            $Source,
            $Destination,
            "/E",           # Copy subdirectories including empty
            "/COPYALL",     # Copy all file info
            "/R:3",         # Retry 3 times
            "/W:5",         # Wait 5 seconds
            "/MT:8",        # Multi-threaded
            "/V",           # Verbose
            "/LOG:$robocopyLog"
        )
        
        # Start robocopy in background
        $robocopyJob = Start-Job -ScriptBlock {
            param($Args)
            $result = Start-Process -FilePath "robocopy.exe" -ArgumentList $Args -Wait -PassThru -NoNewWindow
            return $result.ExitCode
        } -ArgumentList (,$robocopyArgs)
        
        # Monitor progress
        $lastSize = 0
        $startTime = Get-Date
        
        while ($robocopyJob.State -eq 'Running') {
            Start-Sleep -Milliseconds 500
            
            if (Test-Path $Destination) {
                try {
                    $currentSize = (Get-ChildItem $Destination -Recurse -File -ErrorAction SilentlyContinue | 
                                   Measure-Object -Property Length -Sum).Sum
                    $currentFiles = (Get-ChildItem $Destination -Recurse -File -ErrorAction SilentlyContinue | 
                                    Measure-Object).Count
                    
                    if ($currentFiles -gt 0) {
                        Show-ProgressBar -Current $FolderIndex -Total $TotalFolders `
                                       -Activity "Overall Progress: $FolderName" `
                                       -Status "Copying files" -Id 0
                        
                        Show-SubProgress -Current $currentFiles -Total $fileCount `
                                       -Activity "Copying $FolderName" `
                                       -Status "$currentFiles of $fileCount files copied"
                        
                        # Calculate speed
                        $elapsed = ((Get-Date) - $startTime).TotalSeconds
                        if ($elapsed -gt 0) {
                            $speed = [math]::Round($currentSize / $elapsed / 1MB, 2)
                            $currentSizeGB = [math]::Round($currentSize / 1GB, 2)
                            Write-Host "`r  ğŸ’¨ Speed: $speed MB/s  |  Copied: $currentSizeGB GB  |  Files: $currentFiles/$fileCount" -NoNewline -ForegroundColor Gray
                        }
                    }
                } catch {
                    # Ignore errors during progress monitoring
                }
            }
        }
        
        Write-Host "`r" + (" " * 120) + "`r" -NoNewline  # Clear progress line
        
        # Get result
        $exitCode = Receive-Job $robocopyJob
        Remove-Job $robocopyJob
        
        # Clean up log
        if (Test-Path $robocopyLog) {
            Remove-Item $robocopyLog -Force
        }
        
        # Robocopy exit codes 0-7 are success
        if ($exitCode -le 7) {
            Write-StatusLine "âœ“" "Copy completed successfully" $colors.Success
            
            # Verify
            Write-StatusLine "ğŸ”" "Verifying files..." $colors.Progress -NoNewLine
            $destFiles = Get-FileCount $Destination
            
            if ($destFiles -eq $fileCount) {
                Write-Host " âœ“ Verified: $destFiles files" -ForegroundColor $colors.Success
            } else {
                Write-Host " âš ï¸ File count mismatch: Source=$fileCount, Dest=$destFiles" -ForegroundColor $colors.Warning
            }
            
            # Create symlink
            if ($CreateSymlink) {
                Write-StatusLine "ğŸ”—" "Creating symbolic link..." $colors.Progress -NoNewLine
                
                $backupPath = "$Source.original"
                if (Test-PathExists $backupPath) {
                    Remove-Item $backupPath -Recurse -Force
                }
                
                Rename-Item -Path $Source -NewName "$Source.original" -Force
                New-Item -ItemType SymbolicLink -Path $Source -Target $Destination -Force | Out-Null
                
                Write-Host " âœ“ Symlink created" -ForegroundColor $colors.Success
                Write-StatusLine "ğŸ“" "Original backed up to: $backupPath" "Gray"
            }
            
            $script:stats.MoveSuccess++
            $script:stats.Folders += $FolderName
            
            Write-Progress -Id 0 -Activity "Overall Progress" -Completed
            Write-Progress -Id 1 -Activity "Sub Progress" -Completed
            
            Write-Host ""
            return $true
        } else {
            throw "Robocopy failed with exit code: $exitCode"
        }
    } catch {
        Write-Host "`r" + (" " * 120) + "`r" -NoNewline  # Clear progress line
        Write-StatusLine "âŒ" "ERROR: $($_.Exception.Message)" $colors.Error
        $script:stats.MoveFailed++
        
        Write-Progress -Id 0 -Activity "Overall Progress" -Completed
        Write-Progress -Id 1 -Activity "Sub Progress" -Completed
        
        Write-Host ""
        return $false
    }
}

# ============================================================================
# MAIN SCRIPT
# ============================================================================

Write-Header "AUTOMATED C: DRIVE ORGANIZATION"

# Validate parameters
if ($DestinationType -eq "Drive" -and [string]::IsNullOrEmpty($DestinationDrive)) {
    Write-Host "âŒ ERROR: DestinationDrive required when using Drive type!" -ForegroundColor $colors.Error
    exit 1
}

if ($DestinationType -eq "NAS" -and [string]::IsNullOrEmpty($NASPath)) {
    Write-Host "âŒ ERROR: NASPath required when using NAS type!" -ForegroundColor $colors.Error
    exit 1
}

# Setup logging
$timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
$logFile = "C:\CDrive_Organization_Log_$timestamp.txt"
Start-Transcript -Path $logFile

Write-Host "ğŸ“ Log file: $logFile`n" -ForegroundColor Gray

$userName = $env:USERNAME
Write-Host "ğŸ‘¤ User: $userName`n" -ForegroundColor $colors.Info

# ============================================================================
# PHASE 1: DISCOVERY
# ============================================================================

Write-Step "PHASE 1: DISCOVERY & ANALYSIS" $colors.Header

Write-Host "ğŸ“Š Checking available drives...`n" -ForegroundColor $colors.Info

$drives = Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Used -ne $null} | Select-Object Name, 
    @{Name='Used(GB)';Expression={[math]::Round($_.Used/1GB,2)}}, 
    @{Name='Free(GB)';Expression={[math]::Round($_.Free/1GB,2)}}, 
    @{Name='Total(GB)';Expression={[math]::Round(($_.Used + $_.Free)/1GB,2)}},
    @{Name='% Free';Expression={[math]::Round(($_.Free/($_.Used + $_.Free))*100,1)}}

$drives | Format-Table -AutoSize

# Check destination
if ($DestinationType -eq "Drive") {
    $destDriveLetter = $DestinationDrive.TrimEnd(':')
    $destDrive = $drives | Where-Object {$_.Name -eq $destDriveLetter}
    
    if (!$destDrive) {
        Write-Host "âŒ ERROR: Drive $DestinationDrive not found!" -ForegroundColor $colors.Error
        Stop-Transcript
        exit 1
    }
    
    Write-Host "ğŸ¯ Destination: $DestinationDrive" -ForegroundColor $colors.Success
    Write-Host "   Free Space: $($destDrive.'Free(GB)') GB" -ForegroundColor $colors.Info
    Write-Host ""
    
    $destinationBase = $DestinationDrive.TrimEnd('\')
} else {
    Write-Host "ğŸ¯ Destination: NAS" -ForegroundColor $colors.Success
    Write-Host "   Path: $NASPath" -ForegroundColor $colors.Info
    
    Write-Host "`nğŸ”Œ Testing NAS connection..." -ForegroundColor $colors.Progress
    if (!(Test-PathExists $NASPath)) {
        Write-Host "âŒ ERROR: Cannot access NAS: $NASPath" -ForegroundColor $colors.Error
        Stop-Transcript
        exit 1
    }
    Write-Host "âœ“ NAS connection successful`n" -ForegroundColor $colors.Success
    
    $destinationBase = $NASPath.TrimEnd('\')
}

# ============================================================================
# PHASE 2: IDENTIFY FOLDERS
# ============================================================================

Write-Step "PHASE 2: IDENTIFYING FOLDERS TO MOVE" $colors.Header

$foldersToMove = @()

# GitHub Repos
$githubPaths = @(
    "C:\Users\$userName\Documents\GitHub",
    "C:\Users\$userName\source\repos",
    "C:\Users\$userName\repos",
    "C:\Development",
    "C:\Projects",
    "C:\GitHub"
)

foreach ($path in $githubPaths) {
    if (Test-PathExists $path) {
        $foldersToMove += @{
            Name = "GitHub-Repos"
            Source = $path
            Destination = "$destinationBase\GitHub-Repos"
            Priority = 1
            CreateSymlink = $true
        }
        Write-Host "âœ“ Found: GitHub repos at $path" -ForegroundColor $colors.Success
        break
    }
}

# Docker Configs
if (!$SkipDocker) {
    $dockerPaths = @(
        "C:\ProgramData\Docker",
        "C:\Users\$userName\.docker",
        "C:\docker"
    )
    
    foreach ($path in $dockerPaths) {
        if (Test-PathExists $path) {
            $foldersToMove += @{
                Name = "Docker-Configs"
                Source = $path
                Destination = "$destinationBase\Docker-Configs"
                Priority = 1
                CreateSymlink = $true
            }
            Write-Host "âœ“ Found: Docker configs at $path" -ForegroundColor $colors.Success
        }
    }
}

# Custom Scripts
$scriptPaths = @(
    "C:\Scripts",
    "C:\Users\$userName\Scripts"
)

foreach ($path in $scriptPaths) {
    if (Test-PathExists $path) {
        $foldersToMove += @{
            Name = "Scripts"
            Source = $path
            Destination = "$destinationBase\Scripts"
            Priority = 2
            CreateSymlink = $true
        }
        Write-Host "âœ“ Found: Scripts at $path" -ForegroundColor $colors.Success
    }
}

# Browser Data
if (!$SkipBrowser) {
    $browserPaths = @(
        @{Name="Chrome"; Path="$env:LOCALAPPDATA\Google\Chrome\User Data"},
        @{Name="Edge"; Path="$env:LOCALAPPDATA\Microsoft\Edge\User Data"}
    )
    
    foreach ($browser in $browserPaths) {
        if (Test-PathExists $browser.Path) {
            $foldersToMove += @{
                Name = "Browser-$($browser.Name)"
                Source = $browser.Path
                Destination = "$destinationBase\Backups\Browser-$($browser.Name)"
                Priority = 2
                CreateSymlink = $false
            }
            Write-Host "âœ“ Found: $($browser.Name) data" -ForegroundColor $colors.Success
        }
    }
}

# SSH Keys & Configs
$configPaths = @(
    "C:\Users\$userName\.ssh",
    "C:\Users\$userName\.gitconfig"
)

$hasConfigs = $false
foreach ($path in $configPaths) {
    if (Test-PathExists $path) {
        $hasConfigs = $true
        break
    }
}

if ($hasConfigs) {
    $tempBundle = "C:\Temp\Config-Bundle-$timestamp"
    New-Item -ItemType Directory -Path $tempBundle -Force | Out-Null
    
    foreach ($path in $configPaths) {
        if (Test-PathExists $path) {
            $itemName = Split-Path $path -Leaf
            Copy-Item $path -Destination "$tempBundle\$itemName" -Recurse -Force
            Write-Host "âœ“ Added to config bundle: $itemName" -ForegroundColor $colors.Success
        }
    }
    
    if (Test-PathExists $PROFILE) {
        Copy-Item $PROFILE -Destination "$tempBundle\PowerShell-Profile.ps1" -Force
        Write-Host "âœ“ Added to config bundle: PowerShell Profile" -ForegroundColor $colors.Success
    }
    
    $foldersToMove += @{
        Name = "SSH-and-Configs"
        Source = $tempBundle
        Destination = "$destinationBase\Backups\Configs"
        Priority = 2
        CreateSymlink = $false
    }
}

# Development Projects
$devPaths = @(
    "C:\Users\$userName\source",
    "C:\Users\$userName\projects"
)

foreach ($path in $devPaths) {
    if (Test-PathExists $path) {
        $folderName = Split-Path $path -Leaf
        $foldersToMove += @{
            Name = "Dev-$folderName"
            Source = $path
            Destination = "$destinationBase\Development\$folderName"
            Priority = 1
            CreateSymlink = $true
        }
        Write-Host "âœ“ Found: Development folder at $path" -ForegroundColor $colors.Success
    }
}

Write-Host ""

if ($foldersToMove.Count -eq 0) {
    Write-Host "âš ï¸  No folders found to move!" -ForegroundColor $colors.Warning
    Stop-Transcript
    exit 0
}

Write-Host "ğŸ“‹ Found $($foldersToMove.Count) folder(s) to move`n" -ForegroundColor $colors.Info

# ============================================================================
# PHASE 3: CONFIRMATION
# ============================================================================

Write-Step "PHASE 3: CONFIRMATION" $colors.Header

Write-Host "The following folders will be moved:`n" -ForegroundColor $colors.Info

foreach ($folder in ($foldersToMove | Sort-Object Priority)) {
    $size = Get-FolderSize $folder.Source
    $files = Get-FileCount $folder.Source
    
    Write-Host "  ğŸ“¦ $($folder.Name)" -ForegroundColor $colors.Info
    Write-Host "     From: $($folder.Source)" -ForegroundColor Gray
    Write-Host "     To: $($folder.Destination)" -ForegroundColor Gray
    Write-Host "     Size: $size GB  |  Files: $files" -ForegroundColor Gray
    Write-Host "     Symlink: $(if($folder.CreateSymlink){'Yes'}else{'No'})" -ForegroundColor Gray
    Write-Host ""
}

if ($DryRun) {
    Write-Host "ğŸ” DRY RUN MODE - No files will be moved`n" -ForegroundColor $colors.Progress
} elseif (!$AutoConfirm) {
    Write-Host "â“ Type 'MOVE' to proceed or anything else to cancel: " -ForegroundColor $colors.Warning -NoNewline
    $confirmation = Read-Host
    
    if ($confirmation -ne "MOVE") {
        Write-Host "`nâŒ Operation cancelled by user" -ForegroundColor $colors.Warning
        Stop-Transcript
        exit 0
    }
}

# ============================================================================
# PHASE 4: MIGRATION WITH PROGRESS BARS
# ============================================================================

Write-Step "PHASE 4: MIGRATION" $colors.Header

$startTime = Get-Date
$sortedFolders = $foldersToMove | Sort-Object Priority
$totalFolders = $sortedFolders.Count
$currentFolder = 0

foreach ($folder in $sortedFolders) {
    $currentFolder++
    $success = Move-FolderWithProgress -Source $folder.Source `
                                       -Destination $folder.Destination `
                                       -FolderName $folder.Name `
                                       -CreateSymlink $folder.CreateSymlink `
                                       -FolderIndex $currentFolder `
                                       -TotalFolders $totalFolders
}

$endTime = Get-Date
$duration = $endTime - $startTime

# ============================================================================
# PHASE 5: VERIFICATION
# ============================================================================

Write-Step "PHASE 5: POST-MIGRATION VERIFICATION" $colors.Header

Write-Host "ğŸ” Verifying moved folders...`n" -ForegroundColor $colors.Info

foreach ($folder in $sortedFolders) {
    if (Test-PathExists $folder.Destination) {
        $destSize = Get-FolderSize $folder.Destination
        Write-Host "âœ“ $($folder.Name): $destSize GB" -ForegroundColor $colors.Success
    } else {
        Write-Host "âŒ $($folder.Name): NOT FOUND!" -ForegroundColor $colors.Error
    }
}

Write-Host ""

# Check symlinks
Write-Host "ğŸ”— Checking symbolic links...`n" -ForegroundColor $colors.Info

$userFolder = "C:\Users\$userName"
$symlinks = Get-ChildItem $userFolder -Force -ErrorAction SilentlyContinue | 
    Where-Object {$_.Attributes -band [System.IO.FileAttributes]::ReparsePoint}

if ($symlinks) {
    foreach ($link in $symlinks) {
        Write-Host "âœ“ $($link.Name) â†’ $($link.Target)" -ForegroundColor $colors.Success
    }
} else {
    Write-Host "  No symlinks found in user folder" -ForegroundColor Gray
}

Write-Host ""

# ============================================================================
# PHASE 6: FINAL REPORT
# ============================================================================

Write-Header "MIGRATION COMPLETE"

Write-Host "ğŸ“Š MIGRATION STATISTICS:" -ForegroundColor $colors.Info
Write-Host ""
Write-Host "   Duration: $($duration.ToString('hh\:mm\:ss'))" -ForegroundColor $colors.Info
Write-Host "   Total Files Processed: $($script:stats.TotalFiles)" -ForegroundColor $colors.Info
Write-Host "   Total Size Moved: $([math]::Round($script:stats.TotalSize, 2)) GB" -ForegroundColor $colors.Info
Write-Host "   Successful Moves: $($script:stats.MoveSuccess)" -ForegroundColor $colors.Success
Write-Host "   Failed Moves: $($script:stats.MoveFailed)" -ForegroundColor $(if($script:stats.MoveFailed -gt 0){$colors.Error}else{$colors.Success})
Write-Host ""

if ($script:stats.Folders.Count -gt 0) {
    Write-Host "âœ… Successfully moved:" -ForegroundColor $colors.Success
    foreach ($folder in $script:stats.Folders) {
        Write-Host "   â€¢ $folder" -ForegroundColor $colors.Info
    }
    Write-Host ""
}

$cDrive = Get-PSDrive C
Write-Host "ğŸ’¾ C: DRIVE STATUS:" -ForegroundColor $colors.Info
Write-Host "   Used: $([math]::Round($cDrive.Used/1GB,2)) GB" -ForegroundColor $colors.Info
Write-Host "   Free: $([math]::Round($cDrive.Free/1GB,2)) GB" -ForegroundColor $colors.Info
Write-Host ""

if ($DestinationType -eq "Drive") {
    $destDrive = Get-PSDrive ($DestinationDrive.TrimEnd(':'))
    Write-Host "ğŸ’¾ $DestinationDrive DRIVE STATUS:" -ForegroundColor $colors.Info
    Write-Host "   Used: $([math]::Round($destDrive.Used/1GB,2)) GB" -ForegroundColor $colors.Info
    Write-Host "   Free: $([math]::Round($destDrive.Free/1GB,2)) GB" -ForegroundColor $colors.Info
    Write-Host ""
}

Write-Host "ğŸ“ Full log saved to: $logFile" -ForegroundColor Gray
Write-Host ""

Write-Host "ğŸ¯ NEXT STEPS:" -ForegroundColor $colors.Warning
Write-Host ""
Write-Host "1. âœ… Verify symlinks work by accessing files from original locations" -ForegroundColor $colors.Info
Write-Host "2. âœ… Test applications (Docker, Git, etc.) still work" -ForegroundColor $colors.Info
Write-Host "3. âœ… Delete .original backup folders once verified" -ForegroundColor $colors.Info
Write-Host "4. ğŸš€ Ready to swap mini PC!" -ForegroundColor $colors.Success
Write-Host ""

Stop-Transcript

Write-Host "âœ… All done! You can now safely swap your mini PC." -ForegroundColor $colors.Success